<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.63">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-135618258-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-135618258-1",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="MikroORM" href="/opensearch.xml">
<script src="/js/custom.js"></script><title data-react-helmet="true">Unit of Work and Transactions | MikroORM</title><meta data-react-helmet="true" name="docsearch:version" content="3.4"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Unit of Work and Transactions | MikroORM"><meta data-react-helmet="true" name="description" content="MikroORM uses the Identity Map pattern to track objects. Whenever you fetch an object from"><meta data-react-helmet="true" property="og:description" content="MikroORM uses the Identity Map pattern to track objects. Whenever you fetch an object from"><meta data-react-helmet="true" property="og:url" content="https://mikro-orm.io/docs/3.4/unit-of-work"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="true"><link data-react-helmet="true" rel="canonical" href="https://mikro-orm.io/docs/3.4/unit-of-work"><link rel="stylesheet" href="/styles.3430c5d5.css">
<link rel="preload" href="/styles.65ec3ed1.js" as="script">
<link rel="preload" href="/runtime~main.9a21b90d.js" as="script">
<link rel="preload" href="/main.2c382faa.js" as="script">
<link rel="preload" href="/1.33fd19f3.js" as="script">
<link rel="preload" href="/2.c7aaa465.js" as="script">
<link rel="preload" href="/3.5c8580e5.js" as="script">
<link rel="preload" href="/1be78505.72548599.js" as="script">
<link rel="preload" href="/342.3aa00248.js" as="script">
<link rel="preload" href="/408ec2eb.7e0311c0.js" as="script">
<link rel="preload" href="/17896441.32028662.js" as="script">
<link rel="preload" href="/a4608ee1.c9a4df0a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top navbarHideable_3046"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="MikroORM"><strong class="navbar__title"></strong></a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/docs/3.4/installation">3.4</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/unit-of-work">Next</a></li><li><a class="dropdown__link" href="/docs/unit-of-work">4.0</a></li><li><a class="dropdown__link" href="/docs/3.6/unit-of-work">3.6</a></li><li><a class="dropdown__link" href="/docs/3.5/unit-of-work">3.5</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/3.4/unit-of-work">3.4</a></li><li><a class="dropdown__link" href="/docs/3.3/unit-of-work">3.3</a></li><li><a class="dropdown__link" href="/docs/2.7/unit-of-work">2.7</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/installation">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" data-type="versions" href="/versions">latest: v4.0.7</a><a href="https://join.slack.com/t/mikroorm/shared_invite/enQtNTM1ODYzMzM4MDk3LWM4ZDExMjU5ZDhmNjA2MmM3MWMwZmExNjhhNDdiYTMwNWM0MGY5ZTE3ZjkyZTMzOWExNDgyYmMzNDE1NDI5NjA" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link" title="Chat on Slack">Slack</a><a href="https://github.com/mikro-orm/mikro-orm" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link" title="View on GitHub">GitHub</a><a href="https://twitter.com/MikroORM" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link" title="Twitter">Twitter</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span><span class="DocSearch-Button-Key">âŒ˜</span><span class="DocSearch-Button-Key">K</span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="MikroORM"><strong class="navbar__title"></strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a target="_blank" rel="noopener noreferrer" class="menu__link menu__link--sublist">Versions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/next/unit-of-work">Next</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/unit-of-work">4.0</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/3.6/unit-of-work">3.6</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/3.5/unit-of-work">3.5</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/docs/3.4/unit-of-work">3.4</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/3.3/unit-of-work">3.3</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/unit-of-work">2.7</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs/installation">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a class="menu__link" data-type="versions" href="/versions">latest: v4.0.7</a></li><li class="menu__list-item"><a href="https://join.slack.com/t/mikroorm/shared_invite/enQtNTM1ODYzMzM4MDk3LWM4ZDExMjU5ZDhmNjA2MmM3MWMwZmExNjhhNDdiYTMwNWM0MGY5ZTE3ZjkyZTMzOWExNDgyYmMzNDE1NDI5NjA" target="_blank" rel="noopener noreferrer" class="menu__link" title="Chat on Slack">Slack</a></li><li class="menu__list-item"><a href="https://github.com/mikro-orm/mikro-orm" target="_blank" rel="noopener noreferrer" class="menu__link" title="View on GitHub">GitHub</a></li><li class="menu__list-item"><a href="https://twitter.com/MikroORM" target="_blank" rel="noopener noreferrer" class="menu__link" title="Twitter">Twitter</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC sidebarWithHideableNavbar_2IoJ"><a tabindex="-1" class="sidebarLogo_Snse" href="/"><img src="/img/logo.svg" alt="MikroORM"><strong></strong></a><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Overview</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/installation">Installation &amp; Usage</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/defining-entities">Defining Entities</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/relationships">Modeling Entity Relationships</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/entity-manager">Entity Manager</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/repositories">Entity Repository</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Fundamentals</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/3.4/identity-map">Identity Map and Request Context</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/3.4/entity-references">Entity References and Reference&lt;T&gt; Wrapper</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/3.4/entity-constructors">Using Entity Constructors</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/3.4/collections">Collections</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/3.4/unit-of-work">Unit of Work</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/3.4/transactions">Transactions and Concurrency</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/3.4/cascading">Cascading</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/3.4/deployment">Deployment</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/3.4/decorators">Decorators Reference</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Advanced Features</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/nested-populate">Smart Nested Populate</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/query-conditions">Smart Query Conditions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/query-builder">Using Query Builder</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/propagation">Propagation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/serializing">Serializing</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/entity-helper">Updating Entity Values</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/property-validation">Property Validation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/lifecycle-hooks">Lifecycle Hooks</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/naming-strategy">Naming Strategy</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/custom-types">Custom Types</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/entity-schema">Defining Entities via EntitySchema</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/metadata-providers">Metadata Providers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/metadata-cache">Metadata Cache</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/debugging">Debugging</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/schema-generator">Schema Generator</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/entity-generator">Entity Generator</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/migrations">Migrations</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/read-connections">Read Replica Connections</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/configuration">Advanced Configuration</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Usage with Different Drivers</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/usage-with-sql">Usage with SQL Drivers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/usage-with-mongo">Usage with MongoDB</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Recipes</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/usage-with-nestjs">Usage with NestJS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/usage-with-js">Usage with Vanilla JS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/custom-driver">Creating Custom Driver</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/multiple-schemas">Using Multiple Schemas</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3.4/using-bigint-pks">Using native BigInt PKs (MySQL and PostgreSQL)</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Example Integrations</a><ul class="menu__list"><li class="menu__list-item"><a href="https://github.com/mikro-orm/express-ts-example-app" target="_blank" rel="noreferrer noopener" class="menu__link" tabindex="-1">Express + MongoDB + TypeScript</a></li><li class="menu__list-item"><a href="https://github.com/mikro-orm/nestjs-example-app" target="_blank" rel="noreferrer noopener" class="menu__link" tabindex="-1">NestJS + MySQL + TypeScript</a></li><li class="menu__list-item"><a href="https://github.com/mikro-orm/nestjs-realworld-example-app" target="_blank" rel="noreferrer noopener" class="menu__link" tabindex="-1">RealWorld example app (Nest + MySQL)</a></li><li class="menu__list-item"><a href="https://github.com/mikro-orm/express-js-example-app" target="_blank" rel="noreferrer noopener" class="menu__link" tabindex="-1">Express + MongoDB + JavaScript</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for MikroORM <strong>3.4</strong>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <strong><a href="/docs/unit-of-work">latest version</a></strong> (4.0).</div></div><div class="docItemContainer_3QWW"><article><div><span class="badge badge--secondary">Version: 3.4</span></div><header><h1 class="docTitle_1Lrw">Unit of Work and Transactions</h1></header><div class="markdown"><p>MikroORM uses the Identity Map pattern to track objects. Whenever you fetch an object from
the database, MikroORM will keep a reference to this object inside its <code>UnitOfWork</code>. </p><p>This allows MikroORM room for optimizations. If you call the EntityManager and ask for an
entity with a specific ID twice, it will return the same instance:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-typescript codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> authorRepository </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> orm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">em</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getRepository</span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">Author</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> jon1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> authorRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">findOne</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> jon2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> authorRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">findOne</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// identity map in action</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">jon1 </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> jon2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// true</span></div></div></div></div></div><p>Only one SELECT query will be fired against the database here. In the second <code>findOne()</code>
call MikroORM will check the identity map first and will skip the database round trip as
it will find the entity already loaded.</p><p>The identity map being indexed by primary keys only allows shortcuts when you ask for objects
by primary key. When you query by other properties, you will still get the same reference,
but two separate database calls will be made:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-typescript codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> authorRepository </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> orm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">em</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getRepository</span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">Author</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> jon1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> authorRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">findOne</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Jon Snow&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> jon2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> authorRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">findOne</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Jon Snow&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// identity map in action</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">jon1 </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> jon2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// true</span></div></div></div></div></div><p>MikroORM only knows objects by id, so a query for different criteria has to go to the database,
even if it was executed just before. But instead of creating a second <code>Author</code> object MikroORM
first gets the primary key from the row and checks if it already has an object inside the
<code>UnitOfWork</code> with that primary key. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="persisting-managed-entities"></a>Persisting Managed Entities<a aria-hidden="true" tabindex="-1" class="hash-link" href="#persisting-managed-entities" title="Direct link to heading">#</a></h2><p>The identity map has a second use-case. When you call <code>em.flush()</code>, MikroORM will
ask the identity map for all objects that are currently managed. This means you don&#x27;t have to
call <code>em.persistLater()</code> over and over again to pass known objects to the
<code>EntityManager</code>. This is a NO-OP for known entities, but leads to much code written that is
confusing to other developers.</p><p>The following code WILL update your database with the changes made to the <code>Author</code> object,
even if you did not call <code>em.persistLater()</code>:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-typescript codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> authorRepository </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> orm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">em</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getRepository</span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">Author</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> jon </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> authorRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">findOne</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">jon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">email</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;foo@bar.com&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> authorRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">flush</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// calling orm.em.flush() has same effect</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="how-mikroorm-detects-changes"></a>How MikroORM Detects Changes<a aria-hidden="true" tabindex="-1" class="hash-link" href="#how-mikroorm-detects-changes" title="Direct link to heading">#</a></h2><p>MikroORM is a data-mapper that tries to achieve persistence-ignorance (PI). This means you
map JS objects into a relational database that do not necessarily know about the database at
all. A natural question would now be, &quot;how does MikroORM even detect objects have changed?&quot;.</p><p>For this MikroORM keeps a second map inside the <code>UnitOfWork</code>. Whenever you fetch an object
from the database MikroORM will keep a copy of all the properties and associations inside
the <code>UnitOfWork</code>. </p><p>Now whenever you call <code>em.flush()</code> MikroORM will iterate over all entities you
previously marked for persisting via <code>em.persistLater()</code>. For each object it will
compare the original property and association values with the values that are currently set
on the object. If changes are detected then the object is queued for a UPDATE operation.
Only the fields that actually changed are updated.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="implicit-transactions"></a>Implicit Transactions<a aria-hidden="true" tabindex="-1" class="hash-link" href="#implicit-transactions" title="Direct link to heading">#</a></h2><p>First and most important implication of having Unit of Work is that it allows handling
transactions automatically. </p><p>When you call <code>em.flush()</code>, all computed changes are queried inside a database
transaction (if supported by given driver). This means that you can control the boundaries
of transactions simply by calling <code>em.persistLater()</code> and once all your changes
are ready, simply calling <code>flush()</code> will run them inside a transaction. </p><blockquote><p>You can also control the transaction boundaries manually via <code>em.transactional(cb)</code>.</p></blockquote><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-typescript codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> user </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> em</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">findOne</span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">User</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">email</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;foo@bar.com&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> car </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Car</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">cars</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">car</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// thanks to bi-directional cascading we only need to persist user entity</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// flushing will create a transaction, insert new car and update user with new email</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> em</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">persistAndFlush</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></div></div></div></div></div><p>You can find more information about transactions in <a href="/docs/3.4/transactions">Transactions and concurrency</a>
page.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="beware-auto-flushing-and-transactions"></a>Beware: Auto-flushing and Transactions<a aria-hidden="true" tabindex="-1" class="hash-link" href="#beware-auto-flushing-and-transactions" title="Direct link to heading">#</a></h3><blockquote><p>Since MikroORM v3, default value for <code>autoFlush</code> is <code>false</code>. That means you need to call
<code>em.flush()</code> yourself to persist changes into database. You can still change this via ORM&#x27;s
options to ease the transition but generally it is not recommended. </p></blockquote><p>Originally there was only <code>em.persist(entity, flush = true)</code> method, that was
automatically flushing changes to database, if not given second <code>false</code> parameter. This
behaviour can be now changed via <code>autoFlush</code> option when initializing the ORM:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-typescript codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> orm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token maybe-class-name">MikroORM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  autoFlush</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// defaults to false in v3, was true in v2</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">orm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">em</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">persist</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Entity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// no auto-flushing now</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> orm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">em</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">flush</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> orm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">em</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">persist</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Entity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// you can still use second parameter to auto-flush</span></div></div></div></div></div><p>When using driver that supports transactions (all SQL drivers), you should either keep auto-flushing
disabled, or use <code>persistLater()</code> method instead, as otherwise each <code>persist()</code> call will immediately
create new transaction to run the query.</p><blockquote><p>This part of documentation is highly inspired by <a href="https://www.doctrine-project.org/projects/doctrine-orm/en/2.6/reference/unitofwork.html" target="_blank" rel="noopener noreferrer">doctrine internals docs</a>
as the behaviour here is pretty much the same.</p></blockquote></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/mikro-orm/mikro-orm/edit/master/docs/versioned_docs/version-3.4/unit-of-work.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2020-03-08T22:05:21.000Z" class="docLastUpdatedAt_217_">3/8/2020</time> by <strong>Martin Adamek</strong></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/3.4/collections"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Collections</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/3.4/transactions"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Transactions and Concurrency Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#persisting-managed-entities" class="table-of-contents__link">Persisting Managed Entities</a></li><li><a href="#how-mikroorm-detects-changes" class="table-of-contents__link">How MikroORM Detects Changes</a></li><li><a href="#implicit-transactions" class="table-of-contents__link">Implicit Transactions</a><ul><li><a href="#beware-auto-flushing-and-transactions" class="table-of-contents__link">Beware: Auto-flushing and Transactions</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/installation">Installation &amp; Usage</a></li><li class="footer__item"><a href="https://github.com/mikro-orm/mikro-orm#-quick-start" target="_blank" rel="noopener noreferrer" class="footer__link-item">Quick Start</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/upgrading-v3-to-v4">Migration from v3 to v4</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/3.6/installation">Version 3.6 docs</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://join.slack.com/t/mikroorm/shared_invite/enQtNTM1ODYzMzM4MDk3LWM4ZDExMjU5ZDhmNjA2MmM3MWMwZmExNjhhNDdiYTMwNWM0MGY5ZTE3ZjkyZTMzOWExNDgyYmMzNDE1NDI5NjA" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack</a></li><li class="footer__item"><a href="https://stackoverflow.com/questions/ask?tags=mikro-orm" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Social</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://twitter.com/MikroOrm" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><iframe src="https://ghbtns.com/github-btn.html?user=mikro-orm&amp;repo=mikro-orm&amp;type=star&amp;count=true" style="margin-top:10px" frameborder="0" scrolling="0" width="100" height="30" title="GitHub Stars"></iframe></li><li class="footer__item"><iframe src="https://ghbtns.com/github-btn.html?user=B4nan&amp;type=sponsor" frameborder="0" scrolling="0" width="130" height="30" title="Sponsor B4nan"></iframe></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><img class="footer__logo" alt="MikroORM" src="/img/logo-header.svg"></div>Copyright Â© 2018-2020 Martin AdÃ¡mek. Built with Docusaurus. Icons made by <a href="https://www.flaticon.com/authors/surang" title="surang">surang</a> and <a href="https://www.flaticon.com/authors/skyclick" title="Skyclick">Skyclick</a>.</div></div></footer></div>
<script src="/styles.65ec3ed1.js"></script>
<script src="/runtime~main.9a21b90d.js"></script>
<script src="/main.2c382faa.js"></script>
<script src="/1.33fd19f3.js"></script>
<script src="/2.c7aaa465.js"></script>
<script src="/3.5c8580e5.js"></script>
<script src="/1be78505.72548599.js"></script>
<script src="/342.3aa00248.js"></script>
<script src="/408ec2eb.7e0311c0.js"></script>
<script src="/17896441.32028662.js"></script>
<script src="/a4608ee1.c9a4df0a.js"></script>
</body>
</html>
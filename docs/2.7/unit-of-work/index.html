<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-135618258-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-135618258-1",{})</script>
<script src="/js/custom.js"></script>

<title data-react-helmet="true">Unit of Work and transactions | MikroORM</title>

<meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"><meta data-react-helmet="true" property="og:title" content="MikroORM"><meta data-react-helmet="true" name="docsearch:version" content="2.7"><meta data-react-helmet="true" name="twitter:card" content="summary"><meta data-react-helmet="true" name="description" content="MikroORM uses the Identity Map pattern to track objects. Whenever you fetch an object from "><meta data-react-helmet="true" property="og:description" content="MikroORM uses the Identity Map pattern to track objects. Whenever you fetch an object from "><meta data-react-helmet="true" property="og:url" content="https://mikro-orm.io/docs/2.7/unit-of-work">

<link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico">


<link rel="stylesheet" href="/styles.d04a9ee5.css">


<link rel="preload" href="/styles.e5c05444.js" as="script">

<link rel="preload" href="/runtime~main.af82bdd6.js" as="script">

<link rel="preload" href="/main.665f742e.js" as="script">

<link rel="preload" href="/1.f8c6135f.js" as="script">

<link rel="preload" href="/2.aa0070f8.js" as="script">

<link rel="preload" href="/3.c53b4016.js" as="script">

<link rel="preload" href="/1be78505.52c78838.js" as="script">

<link rel="preload" href="/98ae78e7.80d3d74c.js" as="script">

<link rel="preload" href="/17896441.7f240ec7.js" as="script">

<link rel="preload" href="/876f9516.921f3f02.js" as="script">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}function e(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}var n=window.matchMedia("(prefers-color-scheme: dark)");n.addListener((function(n){null===e()&&t(n.matches?"dark":"")}));var a=e();null!==a?t(a):n.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a aria-current="page" class="navbar__brand active" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="MikroORM"><strong></strong></a><a class="navbar__item navbar__link" data-type="versions" href="/versions">3.3.1</a><a class="navbar__item navbar__link" href="/docs/installation">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://join.slack.com/t/mikroorm/shared_invite/enQtNTM1ODYzMzM4MDk3LWM4ZDExMjU5ZDhmNjA2MmM3MWMwZmExNjhhNDdiYTMwNWM0MGY5ZTE3ZjkyZTMzOWExNDgyYmMzNDE1NDI5NjA" title="Chat on Slack">Slack</a><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://github.com/mikro-orm/mikro-orm" title="View on GitHub">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a aria-current="page" class="navbar__brand active" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="MikroORM"><strong></strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" data-type="versions" href="/versions">3.3.1</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/installation">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a class="menu__link" target="_blank" rel="noopener noreferrer" href="https://join.slack.com/t/mikroorm/shared_invite/enQtNTM1ODYzMzM4MDk3LWM4ZDExMjU5ZDhmNjA2MmM3MWMwZmExNjhhNDdiYTMwNWM0MGY5ZTE3ZjkyZTMzOWExNDgyYmMzNDE1NDI5NjA" title="Chat on Slack">Slack</a></li><li class="menu__list-item"><a class="menu__link" target="_blank" rel="noopener noreferrer" href="https://github.com/mikro-orm/mikro-orm" title="View on GitHub">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><div class="docSidebarContainer_1cYp"><div class="sidebar_1kLs"><div class="sidebarLogo_3ono"><img src="/img/logo.svg" alt="MikroORM"><strong></strong></div><div class="menu menu--responsive menu_w2sC"><button aria-label="Open Menu" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_2vk4" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Overview</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/installation">Installation &amp; Usage</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/defining-entities">Defining entities</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/entity-manager">Entity Manager</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/repositories">Entity Repository</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Fundamentals</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/identity-map">Identity Map and Request Context</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/entity-references">Entity References</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/entity-constructors">Using entity constructors</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/collections">Collections</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/docs/2.7/unit-of-work">Unit of Work</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/transactions">Transactions and concurrency</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/cascading">Cascading</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Advanced Features</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/nested-populate">Smart Nested Populate</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/query-conditions">Smart query conditions</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/query-builder">Using QueryBuilder</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/serializing">Serializing</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/entity-helper">Updating Entity Values</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/property-validation">Property validation</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/lifecycle-hooks">Lifecycle hooks</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/naming-strategy">Naming strategy</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/metadata-cache">Metadata cache</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/debugging">Debugging</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/schema-generator">Schema generator</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Usage with Different Drivers</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/usage-with-sql">Usage with SQL Drivers</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/usage-with-mongo">Usage with MongoDB</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Recipes</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/usage-with-nestjs">Usage with NestJS</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/usage-with-js">Usage with Vanilla JS</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.7/custom-driver">Creating Custom Driver</a></li></ul></li></ul></div></div></div><main class="docMainContainer_FFX1"><div class="padding-vert--lg"><div class="container"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><span style="vertical-align:top" class="badge badge--info">Version: 2.7</span><header><h1 class="docTitle_1vWb">Unit of Work and transactions</h1></header><div class="markdown"><p>MikroORM uses the Identity Map pattern to track objects. Whenever you fetch an object from
the database, MikroORM will keep a reference to this object inside its <code>UnitOfWork</code>. </p><p>This allows MikroORM room for optimizations. If you call the EntityManager and ask for an
entity with a specific ID twice, it will return the same instance:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-typescript codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> authorRepository </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> orm</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">em</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">getRepository</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token maybe-class-name">Author</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> jon1 </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> authorRepository</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">findOne</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> jon2 </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> authorRepository</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">findOne</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// identity map in action</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token console class-name" style="color:rgb(255, 203, 107)">console</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">log</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">jon1 </span><span class="token operator" style="color:rgb(137, 221, 255)">===</span><span class="token plain"> jon2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// true</span></div></code></pre></div><p>Only one SELECT query will be fired against the database here. In the second <code>findOne()</code>
call MikroORM will check the identity map first and will skip the database round trip as
it will find the entity already loaded.</p><p>The identity map being indexed by primary keys only allows shortcuts when you ask for objects
by primary key. When you query by other properties, you will still get the same reference,
but two separate database calls will be made:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-typescript codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> authorRepository </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> orm</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">em</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">getRepository</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token maybe-class-name">Author</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> jon1 </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> authorRepository</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">findOne</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Jon Snow&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> jon2 </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> authorRepository</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">findOne</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Jon Snow&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// identity map in action</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token console class-name" style="color:rgb(255, 203, 107)">console</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">log</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">jon1 </span><span class="token operator" style="color:rgb(137, 221, 255)">===</span><span class="token plain"> jon2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// true</span></div></code></pre></div><p>MikroORM only knows objects by id, so a query for different criteria has to go to the database,
even if it was executed just before. But instead of creating a second <code>Author</code> object MikroORM
first gets the primary key from the row and checks if it already has an object inside the
<code>UnitOfWork</code> with that primary key. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="persisting-managed-entities"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#persisting-managed-entities" title="Direct link to heading">#</a>Persisting managed entities</h2><p>The identity map has a second use-case. When you call <code>EntityManager#flush()</code>, MikroORM will
ask the identity map for all objects that are currently managed. This means you don&#x27;t have to
call <code>EntityManager#persistLater()</code> over and over again to pass known objects to the
<code>EntityManager</code>. This is a NO-OP for known entities, but leads to much code written that is
confusing to other developers.</p><p>The following code WILL update your database with the changes made to the <code>Author</code> object,
even if you did not call <code>EntityManager#persistLater()</code>:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-typescript codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> authorRepository </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> orm</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">em</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">getRepository</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token maybe-class-name">Author</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> jon </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> authorRepository</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">findOne</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">jon</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">email</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;foo@bar.com&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> authorRepository</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">flush</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// calling orm.em.flush() has same effect</span></div></code></pre></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="how-mikroorm-detects-changes"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#how-mikroorm-detects-changes" title="Direct link to heading">#</a>How MikroORM detects changes</h2><p>MikroORM is a data-mapper that tries to achieve persistence-ignorance (PI). This means you
map JS objects into a relational database that do not necessarily know about the database at
all. A natural question would now be, &quot;how does MikroORM even detect objects have changed?&quot;.</p><p>For this MikroORM keeps a second map inside the <code>UnitOfWork</code>. Whenever you fetch an object
from the database MikroORM will keep a copy of all the properties and associations inside
the <code>UnitOfWork</code>. </p><p>Now whenever you call <code>EntityManager#flush()</code> MikroORM will iterate over all entities you
previously marked for persisting via <code>EntityManager#persistLater()</code>. For each object it will
compare the original property and association values with the values that are currently set
on the object. If changes are detected then the object is queued for a UPDATE operation.
Only the fields that actually changed are updated.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="implicit-transactions"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#implicit-transactions" title="Direct link to heading">#</a>Implicit Transactions</h2><p>First and most important implication of having Unit of Work is that it allows handling
transactions automatically. </p><p>When you call <code>EntityManager#flush()</code>, all computed changes are queried inside a database
transaction (if supported by given driver). This means that you can control the boundaries
of transactions simply by calling <code>EntityManager#persistLater()</code> and once all your changes
are ready, simply calling <code>flush()</code> will run them inside a transaction. </p><blockquote><p>You can also control the transaction boundaries manually via <code>em.transactional(cb)</code>.</p></blockquote><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-typescript codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> user </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> em</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">findOne</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token maybe-class-name">User</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">email</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;foo@bar.com&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> car </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">Car</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">cars</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">add</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">car</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// thanks to bi-directional cascading we only need to persist user entity</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// flushing will create a transaction, insert new car and update user with new email</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> em</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">persistAndFlush</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></code></pre></div><p>You can find more information about transactions in <a href="/docs/2.7/transactions">Transactions and concurrency</a>
page.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="beware-auto-flushing-and-transactions"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#beware-auto-flushing-and-transactions" title="Direct link to heading">#</a>Beware: Auto-flushing and transactions</h3><p>Originally there was only <code>EntityManager#persist(entity, flush = true)</code> method, that was
automatically flushing changes to database, if not given second <code>false</code> parameter. This
behaviour can be now changed via <code>autoFlush</code> option when initializing the ORM:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-typescript codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> orm </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> </span><span class="token maybe-class-name">MikroORM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">init</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  autoFlush</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">false</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> orm</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">em</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">persist</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">Entity</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// no auto-flushing now</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> orm</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">em</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">flush</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> orm</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">em</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">persist</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">Entity</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// you can still use second parameter to auto-flush</span></div></code></pre></div><p>When using driver that supports transactions (all SQL drivers), you should either disable
auto-flushing, or use <code>persistLater()</code> method instead, as otherwise each <code>persist()</code> call
will immediately create new transaction to run the query.</p><p>This behaviour will be changed in v3, <code>autoFlush</code> will stay configurable but the default
value will be <code>false</code>. Users are encouraged to use <code>persistAndFlush()</code> instead if they need
the immediate persist. </p><blockquote><p>This part of documentation is highly inspired by <a href="https://www.doctrine-project.org/projects/doctrine-orm/en/2.6/reference/unitofwork.html">doctrine internals docs</a>
as the behaviour here is pretty much the same.</p></blockquote></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/mikro-orm/mikro-orm/edit/master/docs/versioned_docs/version-2.7/unit-of-work.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/2.7/collections"><h5 class="pagination-nav__link--sublabel">Previous</h5><h4 class="pagination-nav__link--label">« Collections</h4></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/2.7/transactions"><h5 class="pagination-nav__link--sublabel">Next</h5><h4 class="pagination-nav__link--label">Transactions and concurrency »</h4></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="contents contents__left-border"><li><a href="#persisting-managed-entities" class="contents__link">Persisting managed entities</a></li><li><a href="#how-mikroorm-detects-changes" class="contents__link">How MikroORM detects changes</a></li><li><a href="#implicit-transactions" class="contents__link">Implicit Transactions</a><ul><li><a href="#beware-auto-flushing-and-transactions" class="contents__link">Beware: Auto-flushing and transactions</a></li></ul></li></ul></div></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/installation">Installation &amp; Usage</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://github.com/mikro-orm/mikro-orm#-quick-start">Quick Start</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/upgrading-v2-to-v3">Migration from v2 to v3</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/2.7/installation">Version 2.7 docs</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://join.slack.com/t/mikroorm/shared_invite/enQtNTM1ODYzMzM4MDk3LWM4ZDExMjU5ZDhmNjA2MmM3MWMwZmExNjhhNDdiYTMwNWM0MGY5ZTE3ZjkyZTMzOWExNDgyYmMzNDE1NDI5NjA">Slack</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://stackoverflow.com/questions/ask?tags=mikro-orm">Stack Overflow</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Social</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" to="https://twitter.com/B4nan" href="https://twitter.com/B4nan">Twitter</a></li><iframe src="https://ghbtns.com/github-btn.html?user=mikro-orm&amp;repo=mikro-orm&amp;type=star&amp;count=true" style="margin-top:10px" frameborder="0" scrolling="0" width="100" height="30" title="GitHub Stars"></iframe></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><img class="footer__logo" alt="MikroORM" src="/img/logo-header.svg"></div>Copyright © 2018-2020 Martin Adámek. Built with Docusaurus. Icons made by <a href="https://www.flaticon.com/authors/surang" title="surang">surang</a> and <a href="https://www.flaticon.com/authors/skyclick" title="Skyclick">Skyclick</a>.</div></div></footer>
</div>

<script src="/styles.e5c05444.js"></script>

<script src="/runtime~main.af82bdd6.js"></script>

<script src="/main.665f742e.js"></script>

<script src="/1.f8c6135f.js"></script>

<script src="/2.aa0070f8.js"></script>

<script src="/3.c53b4016.js"></script>

<script src="/1be78505.52c78838.js"></script>

<script src="/98ae78e7.80d3d74c.js"></script>

<script src="/17896441.7f240ec7.js"></script>

<script src="/876f9516.921f3f02.js"></script>


</body>
</html>